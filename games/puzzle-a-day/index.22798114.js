function t(t,e,s,i){Object.defineProperty(t,e,{get:s,set:i,enumerable:!0,configurable:!0})}var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{},s={},i={},o=e.parcelRequirec5ad;null==o&&((o=function(t){if(t in s)return s[t].exports;if(t in i){var e=i[t];delete i[t];var o={id:t,exports:{}};return s[t]=o,e.call(o.exports,o,o.exports),o.exports}var r=new Error("Cannot find module '"+t+"'");throw r.code="MODULE_NOT_FOUND",r}).register=function(t,e){i[t]=e},e.parcelRequirec5ad=o),o.register("27Lyk",(function(e,s){var i,o;t(e.exports,"register",(()=>i),(t=>i=t)),t(e.exports,"resolve",(()=>o),(t=>o=t));var r={};i=function(t){for(var e=Object.keys(t),s=0;s<e.length;s++)r[e[s]]=t[e[s]]},o=function(t){var e=r[t];if(null==e)throw new Error("Could not resolve bundle with id "+t);return e}})),o("27Lyk").register(JSON.parse('{"bpvlM":"index.22798114.js","1vJCw":"sprites.7bbc2069.png"}'));const r={x:0,y:-1},n={x:0,y:-1},a={x:0,y:-1},h={x:0,y:-1};function c(t=0,e=0){return new g(t,e)}let l,d,u;!function(t){t[t.North=0]="North",t[t.East=1]="East",t[t.South=2]="South",t[t.West=3]="West"}(l||(l={}));class g{constructor(t=0,e=0){this.x=t,this.y=e}static from({x:t,y:e}){return c(t,e)}static north(){return g.from(r)}static east(){return g.from(n)}static south(){return g.from(a)}static west(){return g.from(h)}toString(t=0){return`{ ${this.x.toFixed(t)},${this.y.toFixed(t)} }`}equalsv(t){return this.equals(t.x,t.y)}equals(t,e){return this.x===t&&this.y===e}add(t,e=t){return c(this.x+t,this.y+e)}addv(t){return c(this.x+t.x,this.y+t.y)}clone(){return c(this.x,this.y)}sub(t,e=t){return c(this.x-t,this.y-e)}subv(t){return c(this.x-t.x,this.y-t.y)}divide(t,e=t){return c(0===t?0:this.x/t,0===e?0:this.y/e)}multiply(t,e=t){return c(this.x*t,this.y*e)}round(){return c(Math.round(this.x),Math.round(this.y))}mag(){return Math.sqrt(this.x*this.x+this.y*this.y)}normalize(){return this.divide(this.mag())}distance(t){return Math.abs(Math.sqrt((this.x-t.x)*(this.x-t.x)+(this.y-t.y)*(this.y-t.y)))}dir(t){return t.subv(this).normalize().round()}static lerp(t,e,s){const i=(t,e)=>(1-s)*t+s*e;return c(i(t.x,e.x),i(t.y,e.y))}static deserialiseDirection(t){if(t.equalsv(g.north()))return l.North;if(t.equalsv(g.east()))return l.East;if(t.equalsv(g.south()))return l.South;if(t.equalsv(g.west()))return l.West;throw new Error("unable to deserialise direction: "+t.toString())}static isMatchingList(t,e){if(t.length!==e.length)return!1;for(const s of t)if(!e.find((t=>s.equalsv(t))))return!1;return!0}}!function(t){t[t.Idle=0]="Idle",t[t.Primary=1]="Primary",t[t.Secondary=2]="Secondary"}(d||(d={})),function(t){t.Rotate="r",t.Flip="f",t.Save="s",t.Load="l"}(u||(u={}));class p{constructor(t=c(),e){this.pos=t,this.camera=e,this.state=d.Idle,this.isDown=!1,this.downThisFrame=!1}setScreenPos(t){this.pos=t}getWorldPos(){return this.pos.subv(this.camera.getOffset())}getScreenPos(){return this.pos}}class f{constructor(t,e){this.stageOffset=t,this.camera=e,this.keyDownThisFrame=null,this.keyWasDown=null,this.pointerWasDown=!1,this.pointer=new p(c(),this.camera)}start(){document.addEventListener("pointermove",(t=>{const e=c(t.clientX,t.clientY);this.pointer.setScreenPos(e.subv(this.stageOffset))})),document.addEventListener("pointerdown",(t=>{t.preventDefault(),this.pointer.isDown=!0,this.pointer.state=1===t.which?d.Primary:d.Secondary})),document.addEventListener("pointerup",(t=>{this.pointer.state=d.Idle,this.pointer.isDown=!1,this.pointerWasDown=!1})),document.addEventListener("keydown",(t=>{const e=t.key;Object.values(u).includes(e)&&this.keyDownThisFrame!==e&&(this.keyDownThisFrame=e)}))}update(){this.pointer.downThisFrame=!1,this.pointer.isDown&&(this.pointerWasDown||(this.pointer.downThisFrame=!0,this.pointerWasDown=!0)),this.keyWasDown?(this.keyDownThisFrame=null,this.keyWasDown=null):this.keyWasDown=this.keyDownThisFrame}getKeyDownThisFrame(){return this.keyDownThisFrame}isPointerDownThisFrame(){return this.pointer.downThisFrame}isPointerDown(){return this.pointer.isDown}debug(){U.print("pointer",`S: ${this.pointer.getScreenPos()} w: ${this.pointer.getWorldPos()}`),U.print("key",this.keyDownThisFrame??"null"),U.print("pointer",this.isPointerDownThisFrame())}}class w{fmt="[%s]: %s";transport=console;warn(t){this.write(t)}write(t){const e=new Date;this.transport.log(this.format(this.fmt,e.toISOString(),t))}format(t,...e){let s=t;for(const t of e)s=s.replace("%s",t);return s}}const x=window.innerWidth-128,m=window.innerHeight-128;function y(t=1){return new v(0,255,0,t).toString()}class v{constructor(t=255,e=255,s=255,i=1){this.r=t,this.g=e,this.b=s,this.a=i}static from(t){return new v(t[0],t[1],t[2],t[3])}static empty(){return new v(0,0,0,0)}static black(){return new v(0,0,0,1)}static red(t=1){return new v(255,0,0,t)}static green(t=1){return new v(0,255,0,t)}static blue(){return new v(0,0,255,1)}static white(t=1){return new v(255,255,255,t)}static magenta(t=1){return new v(255,0,255,t)}toString(){return`rgba(${this.r},${this.g},${this.b},${this.a})`}equals(t){return t.r===this.r&&t.g===this.g&&t.b===this.b&&t.a===this.a}serialise(){return{r:this.r,g:this.g,b:this.b,a:this.a}}}function S(){return document}function D(t="stage",e={}){const s=S().getElementById(t);if(!s)throw new Error(`Could not find #${t} element`);const i=s.getContext("2d",e);if(!i)throw new Error("Could not get 2d context");return{el:s,ctx:i}}function P(t,e,s={}){const i=S().createElement("canvas"),o=i.getContext("2d",s);if(!o)throw new Error("Could not get 2d context");return i.width=t,i.height=e,o.imageSmoothingEnabled=!1,{el:i,ctx:o}}function b(t,e,s,i){return new T(t,e,s,i)}class T{get x(){return this.pos.x}get y(){return this.pos.y}get w(){return this.width}get h(){return this.height}constructor(t,e,s,i){this.pos=c(t,e),this.width=s,this.height=i}contains(t){return!(t.x<this.pos.x||t.x>this.pos.x+(this.width-1))&&!(t.y<this.pos.y||t.y>this.pos.y+(this.height-1))}multiply(t){return b(this.pos.x*t,this.pos.y*t,this.width*t,this.height*t)}toString(){return`{x:${this.pos.x},y:${this.pos.y},w:${this.width},h:${this.height}}`}addv(t){const e=this.pos.addv(t);return b(e.x,e.y,this.width,this.height)}static getRect(t){return new T(t.pos.x,t.pos.y,t.width,t.height)}}let W,R;!function(t){t[t.TopRight=0]="TopRight",t[t.BottomRight=1]="BottomRight"}(W||(W={})),function(t){t[t.Small=0]="Small"}(R||(R={}));class C{constructor(t,e,s){this.content=t,this.pos=e,this.size=s}getRect(){const t=this.getPos(),[e,s]=this.getWidthAndHeight();return b(t.x,t.y,e,s)}getPos(){const[t,e]=this.getWidthAndHeight();switch(this.pos){case W.TopRight:return c(x/2,16);case W.BottomRight:return c(x/2,m-e-16);default:throw new Error(`Cannot draw panel with position: ${this.pos}`)}}getWidthAndHeight(){if(this.size===R.Small)return[x/2-16,m/4-16];throw new Error(`Cannot draw panel with size: ${this.size}`)}setContent(t){this.content=t}draw(){const[t,e]=this.getWidthAndHeight(),s=this.getPos();G.fillRect(s,t,e,v.black(),c(),"ui"),G.fillText(this.content,s.add(16,24),v.white(),t-32,"ui")}}class F{constructor(t=[]){this.map=new Map(t)}entries(){return this.map.entries()}values(){return this.map.values()}set(t,e){this.map.set(t,e)}get(t){if(!this.map.has(t))throw new Error(`Attempted to access unset key "${t}" in safe map!`);return this.map.get(t)}}class E{constructor(t,e,s){this.canvas=t,this.ctx=e,this.layers=s,this.queue=new Set;const i=this.canvas.getBoundingClientRect();this.stage=b(0,0,i.width,i.height),this.ctx.font="16px monospace"}clear(){this.ctx.clearRect(0,0,x,m),this.ctx.save(),this.ctx.fillStyle=new v(21,50,67).toString(),this.ctx.fillRect(0,0,x,m),this.ctx.restore()}getWorldPos(t,e,s="default"){return"ui"===s?t.clone():t.addv(e)}fillRect(t,e,s,i,o=c(),r="defaultl"){this.queue.add({draw:n=>{const a=this.getWorldPos(t,n,r).addv(o);this.ctx.save(),this.ctx.fillStyle=i.toString(),this.ctx.fillRect(a.x,a.y,e,s),this.ctx.restore()},z:this.layers.get(r),y:t.y})}drawISoRect(t,e,s,i,o=!0,r=c(0,0),n=4,a="default"){this.queue.add({draw:h=>{const c=this.getWorldPos(t,h,a).addv(r);this.ctx.save(),this.ctx.beginPath(),o?this.ctx.fillStyle=i.toString():(this.ctx.strokeStyle=i.toString(),this.ctx.lineWidth=n),this.ctx.moveTo(c.x,c.y),this.ctx.lineTo(c.x+e,c.y+s/2),this.ctx.lineTo(c.x,c.y+s),this.ctx.lineTo(c.x-e,c.y+s/2),this.ctx.closePath(),o?this.ctx.fill():this.ctx.stroke(),this.ctx.restore()},z:this.layers.get(a),y:t.y})}strokeRect(t,e,s,i,o="default"){this.queue.add({draw:r=>{const n=this.getWorldPos(t,r,o);this.ctx.save(),this.ctx.strokeStyle=i,this.ctx.strokeRect(n.x,n.y,e,s),this.ctx.restore()},z:this.layers.get(o),y:t.y})}fillText(t,e,s,i,o="default"){this.queue.add({draw:r=>{const n=this.getWorldPos(e,r,o);this.ctx.save(),this.ctx.fillStyle=s.toString(),this.ctx.font="16px monospace","ui"===o&&(this.ctx.font="16px monospace");let a=0;for(const e of t.split("\n"))this.ctx.fillText(e,n.x,n.y+a,i),a+=16;this.ctx.restore()},z:this.layers.get(o),y:e.y})}path(t,e,s,i="default"){this.queue.add({draw:i=>{this.ctx.save(),this.ctx.beginPath(),this.ctx.strokeStyle=e.toString(),this.ctx.lineWidth=s;for(let e=0;e<t.length;e++){const{x:s,y:o}=t[e].addv(i);0===e?this.ctx.moveTo(s,o):this.ctx.lineTo(s,o)}for(const e of t.slice(1))this.ctx.lineTo(e.addv(i).x,e.addv(i).y);this.ctx.closePath(),this.ctx.stroke(),this.ctx.restore()},z:this.layers.get(i),y:t[0].y})}renderSprite(t,e,s=v.empty(),i=1,o="default",r=0){this.queue.add({draw:s=>{const n=K.get(t),a=n.getFrame(r),h=this.getWorldPos(e,s,o);if(!n)return this.ctx.fillStyle=v.magenta().toString(),this.ctx.save(),this.ctx.fillRect(h.x,h.y,32,32),void this.ctx.restore();const c=h.addv(n.getOffset(r)),l=n.getWidth(),d=n.getHeight();let u=a.img;i&&(this.ctx.globalAlpha=i),this.ctx.save(),this.ctx.drawImage(u,0,0,l,d,c.x,c.y,l,d),this.ctx.restore()},y:e.y,z:this.layers.get(o)})}draw(t){const e=new Map;for(const t of this.queue){const s=e.get(t.z)??[];e.set(t.z,[...s,t])}for(const t of e.values())t.sort(((t,e)=>t.y-e.y));const s=[...e.keys()].sort(((t,e)=>t-e));for(const i of s){const s=e.get(i);for(const e of s)this.ctx.save(),e.draw(t),this.ctx.restore()}this.queue.clear()}willDraw(t){return this.stage.contains(t)}}function N(t,e,s){return t<e?e:t>s?s:t}class A{constructor(t){this.ctx=t,this.y=0,this.padding=c(16,28),this.size=12,this.style=`${this.size}px monospace`,this.queue=new Set,this.sampleCache=new Map}enqueue(t){this.queue.add(t)}print(t,e,s=y()){this.enqueue({fn:()=>{this.ctx.save(),this.ctx.fillStyle=s,this.ctx.fillText(`${t}: ${e.toString()}`,this.padding.x,this.padding.y+this.y),this.ctx.restore()}})}sample(t,e,s,i=(t=>t.toString()),o=y()){if(s<=1)throw new Error("Cannot sample 1 value!");const r=this.sampleCache.get(t);if(!r)return void this.sampleCache.set(t,{size:s,values:[e],lastSampleValue:0});let n=[...r.values,e],a=r.lastSampleValue;var h;n.length===r.size&&(n=[],a=(h=r.values).length?h.reduce(((t,e)=>t+e),0)/h.length:0),this.print(t,i(a),o),this.sampleCache.set(t,{size:s,values:n,lastSampleValue:a})}draw(){for(const{fn:t}of this.queue)this.ctx.save(),this.ctx.font=this.style,t(),this.y+=this.size,this.ctx.restore();this.queue.clear(),this.y=0}}class _{colliders=new Set;cache=null;constructor(){const t=D("collision",{willReadFrequently:!0});t.el.width=G.canvas.width,t.el.height=G.canvas.height,this.ctx=t.ctx}addCollider(t){this.colliders.add(t)}removeCollider(t){this.colliders.delete(t)}getObjAt(t){Date.now();const e=j.getOffset(),s=[];for(const i of this.colliders){if(!i.obj)continue;const o=i.getWorldPath()?.map((t=>t.addv(e)));if(o.every((t=>!G.willDraw(t)))&&i.disable(),i.isEnabled()){this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.ctx.beginPath(),this.ctx.fillStyle="red";for(let t=0;t<o.length;t++)0===t?this.ctx.moveTo(o[t].x,o[t].y):this.ctx.lineTo(o[t].x,o[t].y);this.ctx.fill(),this.ctx.closePath(),this.cache=this.ctx.getImageData(t.x,t.y,1,1).data,(this.cache[0]||this.cache[1]||this.cache[2])&&s.push(i.obj),this.ctx.fillStyle="blue",this.ctx.fillRect(t.x,t.y,4,4)}}return s}debug(){false}}class L{constructor(t,e){this.renderer=t,this.pos=e,this.pointerAnchor=c(),this.posAnchor=c()}getOffset(){return this.pos.add(x/2,m/2)}snapTo(t){this.pos=t}update(t){Y.isPointerDown()&&Y.pointer.state===d.Secondary&&(Y.isPointerDownThisFrame()&&(this.pointerAnchor=Y.pointer.getScreenPos(),this.posAnchor=this.pos.clone()),this.pos=this.posAnchor.addv(Y.pointer.getScreenPos().subv(this.pointerAnchor)))}debug(){}draw(){this.renderer.draw(this.getOffset())}}class z{constructor(t,e=0,s=0){this.name=t,this.width=e,this.height=s,this.frames=[]}addFrame(t){this.frames.push(t),this.width=Math.max(this.width,t.width),this.height=Math.max(this.height,t.height)}getFrames(){return this.frames}getFrameLen(){return this.frames.length}getFrame(t){if(!this.frames[t])throw new Error(`sprite frame not loaded: "${t}"`);return this.frames[t]}getOffset(t){if(!this.frames[t])throw new Error(`sprite frame not loaded: "${t}"`);return this.frames[t].offset}getWidth(){return this.width}getHeight(){return this.height}getName(){return this.name}}let O=0;class k{sprites=new F;constructor(){}get(t){return this.sprites.get(t)}getByPrefix(t){const e=[];for(const[s,i]of this.sprites.entries())s.startsWith(t)&&e.push(i);return e}async loadSheet(t,e,s){await this.sliceSheet(t,e,s)}getSprites(){return[...this.sprites.values()]}applyScale(t){return{x:2*t.x,y:2*t.y,w:2*t.w,h:2*t.h,ox:t.ox,oy:t.oy}}async sliceSheet(t,e,s){const i=await this.loadAsset("sheet",e);for(const t in s){const e=new z(t);for(let o=0;o<s[t].frames.length;o++){const r=this.applyScale(s[t].frames[o]);this.sliceSprite(e,i,r,t,o),this.sprites.set(e.getName(),e)}}}addSprite(t){this.sprites.set(t.getName(),t)}sliceSprite(t,e,s,i,o=O++){const r=b(s.x,s.y,s.w,s.h),n=P(r.w,r.h,{willReadFrequently:!0}),a=e.getImageData(r.x,r.y,r.w,r.h);n.ctx.putImageData(a,0,0),t.addFrame({img:n.ctx.canvas,offset:c(s.ox,s.oy),width:s.w,height:s.h})}debugSprite(t,e){const s=e.el.cloneNode(),i=s.getContext("2d"),o=e.ctx.getImageData(0,0,e.el.width,e.el.height);document.getElementById("resource-catalogue").appendChild(s),i.putImageData(o,0,0),i.fillStyle=v.red().toString(),i.strokeStyle=v.red().toString(),i.fillText(t,8,16),i.strokeRect(0,0,e.el.width,e.el.height)}loadAsset(t,e){const s=document.createElement("img");return new Promise(((t,i)=>{s.onerror=i,s.onload=()=>{const e=2*s.width,i=2*s.height,o=P(e,i);o.ctx.drawImage(s,0,0,e,i),o.el.setAttribute("style","border: 1px solid red"),t(o.ctx)},s.src=e}))}}class M{listeners=new Map;eventsFired=[];listen(t,e){const s=this.listeners.get(t),i=s?[...s,e]:[e];this.listeners.set(t,i)}remove(t,e){const s=this.listeners.get(t);if(s){for(const i of s)if(i===e)return void this.listeners.set(t,s.filter((t=>t!==i)));console.warn("Attempted to remove handler that was not attached",t,e)}else console.warn("Attempted to remove handler that was not attached",t,e)}trigger(t,e){const s=this.listeners.get(t);if(s&&s.length){this.eventsFired.push({name:t,fired:Date.now()});for(const t of s)t(e)}}}class I{panels=new Set;addPanel(t){this.panels.add(t)}drawPanel(t){this.panels.add(t)}removePanel(t,e){for(const s of this.panels)s.pos===t&&s.size===e&&this.panels.delete(s)}update(t){}draw(){}}class q{constructor(t=console){this.transport=t,this.notifications=new Set,this.panel=function(t,e,s=R.Small){return new C(t,e,s)}("",W.BottomRight),J.addPanel(this.panel)}createNotification(t){this.notifications.add({...t,created:Date.now()}),this.transport.log(t.content)}update(){}draw(){const t=[...this.notifications].sort(((t,e)=>t.created-e.created)).slice(N(this.notifications.size-7,0,this.notifications.size)).map((t=>t.content)).join("\n");this.panel.setContent(t)}}class ${scenes=[];activeScene=null;start(){if(!this.scenes.length)throw new Error("no scenes available");return this.activeScene=this.scenes[0],this.activeScene}getActiveScene(){if(null===this.activeScene)throw new Error("no active scene");return this.activeScene}addScene(t){-1===this.scenes.indexOf(t)&&this.scenes.push(t)}}const G=function(t){const e=D();e.ctx.fillStyle=v.black().toString(),e.el.width=x,e.el.height=m;const s=new F;s.set("default",100),s.set("debug",450),s.set("ui",500),s.set("cursor",600);for(const[e,i]of t.entries())s.set(e,i);return new E(e.el,e.ctx,s)}(new F([["board",200],["shadows",299],["pieces",300],["cursor_shadows",399],["cursor_pieces",400]])),j=function(t,e=c()){return new L(t,e)}(G),U=(H=G.ctx,new A(H));var H;const B=new _,Y=function(t,e){const s=t.getBoundingClientRect();return new f(c(s.left,s.top),e)}(G.canvas,j),K=(new w,new k),V=new M,J=new I,X=new q,Q=new $;class Z{constructor(t,e,s=null){this.id=t,this.pos=e,this.stateMachine=s,this.offset=c(),this.parent=null,this.children=new Set,this.collider=null,this.enabled=!0,this.handlers=new Map([["onPointerDown",[]]])}isEnabled(){return this.enabled}getState(){if(!this.stateMachine)throw new Error(`Attempted to access state of obj with no state machine ${this.getName()}`);return this.stateMachine.getActiveState().getName()}update(t){this.stateMachine?.update(t);for(const e of this.children.values())e.update(t)}addCollider(t){this.collider=t,this.collider.obj=this,this.collider.enable()}removeCollider(){this.collider?.destroy(),this.collider=null}getWorldPos(){let t=this.pos;return this.parent&&(t=t.addv(this.parent.getWorldPos())),t}destroy(){this.parent?.remove(this),this.collider?.destroy()}debug(){}add(t,e){t.parent&&t.parent.remove(t),t.parent=this,e&&t.setPos(e),this.children.add(t)}setPos(t){this.pos=t}hasChild(t){return this.children.has(t)}setChildren(...t){this.children=new Set;for(const e of t)this.add(e)}remove(t,e=null){this.children.delete(t),t.parent=e}getChildrenRecursive(){const t=[...this.children.values()];for(const e of this.children.values())t.push(...e.getChildrenRecursive());return t}getChildren(){return[...this.children.values()]}getParentsRecursive(t,e=[]){return t?this.getParentsRecursive(t.parent,[...e,t]):e}registerHandler(t,e){const s=this.handlers.get(t);if(void 0===s)throw new Error(`Cannot register handler, unrecognised event "${t}"`);s.push(e)}removeHandler(t,e){const s=this.handlers.get(t);if(void 0===s)throw new Error(`Cannot register handler, unrecognised event "${t}"`);this.handlers.set(t,s.filter((t=>t!==e)))}onPointerDown(){for(const t of this.handlers.get("onPointerDown"))t(this)}onPointerUp(){}onPointerOver(){}onPointerOut(){}getGrid(){const t=this.getParentsRecursive(this.parent),e=new Error(`Cannot get grid, it was not the direct parent of ${this.getName()}`);if(!t.length)throw e;for(const e of t)if(e instanceof st)return e;throw e}}let tt,et=0;class st extends Z{constructor(t,e,s,i,o){super(et++,s),this.width=t,this.height=e,this.pos=s,this.size=i,this.factory=o,this.nodes=[],this.init()}init(){for(let t=0;t<this.width;t++){this.nodes[t]||(this.nodes[t]=[]);for(let e=0;e<this.height;e++){const s=c(t,e);this.nodes[t][e]=this.factory(s,this.localToWorld(s))}}}getName(){return"GRID"}localToWorld(t){return st.cartToIso(t.addv(this.pos)).multiply(this.size)}draw(){G.path([this.localToWorld(c()).sub(0,this.size/2),this.localToWorld(c(this.width,0)).sub(0,this.size/2),this.localToWorld(c(this.width,this.height)).sub(0,this.size/2),this.localToWorld(c(0,this.height)).sub(0,this.size/2),this.localToWorld(c()).sub(0,this.size/2)],v.white(.25),4,"default")}debug(){}worldToLocalUnsafe(t){return this.worldToLocalSnap(t,!1).local}worldToLocalSnap(t,e=!0){const s=st.isoToCart(t).divide(this.size).round();return e&&!this.contains(s)?null:{local:s,world:this.localToWorld(s)}}getCenter(){return this.pos.sub(0,Math.floor(this.height/2)*this.size)}contains(t){let e=!1,s=!1;return this.forEach((({local:i})=>{i.x==t.x&&(e=!0),i.y==t.y&&(s=!0)})),e&&s}forEach(t){this.nodes.forEach((e=>{e.forEach((e=>{t(e)}))}))}static cartToIso(t){const e=g.from(t);return e.x=t.x-t.y,e.y=(t.x+t.y)/2,e}static isoToCart(t){const e=g.from(t);return e.x=(2*t.y+t.x)/2,e.y=(2*t.y-t.x)/2,e}add(t,e=c()){super.add(t,this.localToWorld(e))}}class it extends Z{constructor(t,e,s){super(t,e,s)}debug(){super.debug()}}class ot extends it{}function rt(t){const e=[];for(const s of t)s instanceof it&&e.push(s);return e}function nt(t){const e=[];for(const s of t)s instanceof ot&&e.push(s);return e}function at(){let t=0;return()=>t++}function ht(t,e){switch(e){case tt.X:return t.reverse();case tt.Y:return t.map((t=>t.reverse()))}return t}!function(t){t[t.X=0]="X",t[t.Y=1]="Y"}(tt||(tt={}));class ct extends it{constructor(t,e,s,i=c(),o=v.empty()){super(t,e),this.sprite=s,this.offset=i,this.tint=o}draw(t=1,e="default",s=0){const i=this.getWorldPos().addv(this.offset);G.renderSprite(this.sprite.getName(),i,this.tint,t,e,s)}}class lt extends it{getName(){return"CURSOR"}getPiece(){const t=[...this.children.values()][0];return t instanceof gt?t:null}add(t){const e=mt.getGrid(),s=e.worldToLocalUnsafe(this.pos),i=e.worldToLocalUnsafe(t.pos);t.setAnchor(s.subv(i)),t.setPos(t.pos.subv(this.pos)),super.add(t)}update(t){super.update(t),this.pos=Y.pointer.getWorldPos();const e=this.getPiece(),s=mt.getGrid().worldToLocalSnap(this.pos);if(mt.resetHoverState(),s){if(e){switch(e.hovered=!0,Y.getKeyDownThisFrame()){case u.Rotate:e.rotate();break;case u.Flip:e.flip()}mt.updateTempPlacement(e,s.local)}if(Y.isPointerDownThisFrame()&&Y.pointer.state===d.Primary)if(e){if(e.hovered=!0,!mt.canPlace(e,s.local))return void console.log("cannot place at: ",s.local);this.remove(e),mt.addPieceToGrid(e,s.local),e.animationOffset=c(),mt.isPuzzleComplete()&&alert("WELL DONE")}else{const t=mt.getPieceAt(this.pos);t&&(mt.removePieceFromGrid(t),this.add(t),t.animationOffset=t.animationOffset.add(0,-this.getGrid().size/2))}else{const t=mt.getPieceAt(this.pos);t&&(t.hovered=!0)}}}debug(){super.debug();const t=this.getPiece();t&&t.debug()}draw(){G.fillRect(this.pos,10,10,v.black(),c(),"cursor"),G.fillRect(this.pos.add(2,2),6,6,v.white(),c(),"cursor")}}const dt=at();function ut(t,e,s,i,o,r=c(),n=0,a=c()){return new gt(t,a,function(t){const e=[],s=t.split("\n").filter((t=>0!==t.length));for(let t=0;t<s.length;t++){const i=s[t].split(",").filter((t=>""!==t));for(let s=0;s<i.length;s++)switch(void 0===e[s]&&(e[s]=[]),i[s]){case"x":e[s][t]={local:c(s,t),occupied:!0};break;case"o":e[s][t]={local:c(s,t),occupied:!1}}}return e}(e),i,n,s,o,r)}class gt extends ct{constructor(t,e,s,i,o=0,r=c(0,0),n,a){super(dt(),e,n,c()),this.name=t,this.shape=s,this.color=i,this.rotation=o,this.animationOffset=c(),this.anchor=c(),this.needsUpdate=!1,this.hovered=!1,this.setAnchor(r);for(let t=0;t<this.rotation;t++)this.rotateNodes()}getName(){return`${this.id}_PIECE`}setPos(t){t.equalsv(this.pos)?console.warn("skipping piece pos update"):(super.setPos(t),this.needsUpdate&&(mt.updatePiece(this),this.needsUpdate=!1))}rotateNodes(){const t=function(t){const e=t.length,s=t[0].length,i=[];for(let o=0;o<s;o++){const s=[];for(let i=0;i<e;i++)s.push(t[i][o]);i.push(s)}return i}(this.shape);this.shape=t.reverse()}rotate(){this.needsUpdate=!0,this.rotateNodes(),this.rotation=function(t,e,s){const i=s-e+1,o=(t-e)%i;return(o<0?o+i:o)+e}(this.rotation+1,0,this.sprite.getFrameLen()-1)}flip(){switch(this.needsUpdate=!0,this.rotation){case 0:case 2:return void(this.shape=ht(this.shape,tt.X));case 1:case 3:return void(this.shape=ht(this.shape,tt.Y))}}getLocalPos(){const t=this.getGrid().worldToLocalSnap(this.pos);if(!t)throw new Error("Piece not on grid!");return t.local.addv(this.anchor)}getNodes(){const t=[];return this.forEach(((e,s)=>{s&&t.push(e)})),t}forEach(t){for(let e=0;e<this.shape.length;e++)for(let s=0;s<this.shape[e].length;s++)t(c(e,s),this.shape[e][s].occupied)}draw(){const t=this.getWorldPos().addv(this.offset),e=this.parent instanceof lt,s=this.sprite.getName();G.renderSprite(s+"_shadow",t,this.tint,1,e?"cursor_shadows":"shadows",this.rotation),G.renderSprite(this.hovered?s+"_highlight":s,t.addv(this.animationOffset),this.tint,1,e?"cursor_pieces":"pieces",this.rotation)}setAnchor(t){this.anchor=t}getAnchor(){return this.anchor}debug(){}serialiseShape(){const t=[];for(let e=0;e<this.shape.length;e++){t[e]||(t[e]=[]);for(let s=0;s<this.shape[e].length;s++)t[e][s]={local:this.shape[e][s].local,occupied:this.shape[e][s].occupied}}return t}serialise(){return{localPos:this.getLocalPos(),shape:this.serialiseShape(),rotation:this.rotation,color:this.color.serialise(),anchor:this.anchor,name:this.name}}}class pt{pieceMatrix=[];pieces=new Set;grid=null;board=null;debugTempPlacement=[];reset(){this.pieces.clear();for(let t=0;t<this.pieceMatrix.length;t++)for(let e=0;e<this.pieceMatrix[t].length;e++)this.pieceMatrix[t][e]=null}resetHoverState(){for(const t of this.pieces)t.hovered=!1}start(t){this.grid=t,this.grid.forEach((t=>{void 0===this.pieceMatrix[t.local.x]&&(this.pieceMatrix[t.local.x]=[]),this.pieceMatrix[t.local.x][t.local.y]=null}))}getPieces(){return this.pieces}getGrid(){if(null===this.grid)throw new Error("Attempted to access grid before it was initialised");return this.grid}getBoard(){if(null===this.board)throw new Error("No board in piece manager");return this.board}getPieceAt(t){const e=this.getGrid().worldToLocalSnap(t);return e?this.pieceMatrix[e.local.x][e.local.y]:null}removePieceFromGrid(t){this.getGrid().forEach((e=>{this.pieceMatrix[e.local.x][e.local.y]===t&&(this.pieceMatrix[e.local.x][e.local.y]=null)})),this.pieces.delete(t)}addBoardToGrid(t,e){this.board=t,this.board.updateLocalRect(e),this.getGrid().add(t,e)}addPieceToGrid(t,e){this.pieces.has(t)&&this.removePieceFromGrid(t),this.getGrid().add(t,e.subv(t.getAnchor()));const s=this.getGrid().worldToLocalUnsafe(t.pos),i=this.getPieceLocalNodesAtLocalPos(t,s);for(const e of i)this.pieceMatrix[e.x][e.y]=t;this.pieces.add(t)}isPuzzleComplete(){if(!this.board)return!1;const t=this.getBoard(),e=t.getSolutionNodes(),s=[];for(const e of t.getNodes())null===this.pieceMatrix[e.x][e.y]&&s.push(g.from(e));return g.isMatchingList(e,s)}updatePiece(t){if(!this.pieces.has(t))return void console.warn(`Cannot update piece ${t.getName()}, it was not registered`);const e=this.getGrid().worldToLocalSnap(t.pos);null!==e?(this.removePieceFromGrid(t),this.addPieceToGrid(t,e.local)):console.warn("Cannot update piece as it is OOB",t)}updateTempPlacement(t,e){const s=e.subv(t.getAnchor()),i=this.getPieceLocalNodesAtLocalPos(t,s);this.debugTempPlacement=i.map((t=>this.getGrid().localToWorld(t).sub(0,this.getGrid().size/2)))}getPieceLocalNodesAtLocalPos(t,e){return t.getNodes().map((t=>t.addv(e)))}canPlace(t,e){const s=e.subv(t.getAnchor()),i=this.getPieceLocalNodesAtLocalPos(t,s);for(const t of i)if(null!==this.pieceMatrix[t.x][t.y])return!1;return!this.board||!!this.getBoard().isValidPlacement(i)}debug(){}}const ft=new F;function wt(t,e,s,i){ft.set(t,((o=c(),r=0)=>ut(t,e,s,i,K.get(t),c(),r,o)))}wt("piece_0","\nx,o,o,\nx,o,o,\nx,o,o,\nx,x,o,\n  ",c(0,0),v.green()),wt("piece_1","\nx,o,o,\nx,x,o,\no,x,o,\no,x,o,\n  ",c(0,0),v.green()),wt("piece_2","\nx,x,o,\nx,o,o\nx,x,o\n  ",c(0,0),v.green()),wt("piece_3","\nx,o,o\nx,x,o\nx,x,o\n  ",c(0,0),v.green()),wt("piece_4","\nx,o,o\nx,o,o\nx,x,x\n  ",c(0,0),v.green()),wt("piece_5","\nx,o,o\nx,x,o\nx,o,o\nx,o,o\n  ",c(0,0),v.green()),wt("piece_6","\nx,x,o\nx,x,o\nx,x,o\n  ",c(0,0),v.green()),wt("piece_7","\no,x,x\no,x,o\nx,x,o\n  ",c(1,0),v.green());class xt{savedState=null;update(){Y.getKeyDownThisFrame()!==u.Save?Y.getKeyDownThisFrame()!==u.Load||this.loadState():this.saveState()}getSaveStateKey(){return"puzzle-a-day:game-state"}saveState(){const t=[];for(const e of mt.getPieces())t.push(e.serialise());const e={pieces:t};localStorage.setItem(this.getSaveStateKey(),JSON.stringify(e)),console.log("saved scene!",e)}loadState(t){if(Q.getActiveScene().reset(),!t){const e=localStorage.getItem(this.getSaveStateKey());if(!e)return;t=JSON.parse(e)}for(const e of t.pieces){g.from(e.anchor);const t=ft.get(e.name)(c(),e.rotation,g.from(e.anchor));mt.addPieceToGrid(t,g.from(e.localPos))}console.log("loaded scene!",t)}}const mt=new pt,yt=new xt;class vt{constructor(t,e){this.name=t,this.grid=e,this.ui=new Set}reset(){for(const t of this.grid.getChildren())"CURSOR"!==t.getName()&&this.grid.remove(t);mt.reset()}addGameObject(t,e=c()){this.grid.add(t,e)}addUIObject(t,e){this.ui.add(t),t.pos=e}fill(t){this.grid.forEach((({world:e,local:s})=>{this.grid.add(t(),s)}))}update(t){for(const e of this.grid.children)e.update(t);for(const e of this.ui)e.update(t)}draw(){this.grid.draw();for(const t of this.grid.children){const e=rt(t.getChildrenRecursive());t instanceof it&&t.draw();for(const t of e)t.draw()}for(const t of this.ui){const e=nt(t.getChildrenRecursive());t.draw();for(const t of e)t.draw()}}debug(){this.grid.debug();for(const t of this.grid.children)t.debug();{const t=this.grid.getChildrenRecursive(),e=[];for(const t of this.ui){const s=nt(t.getChildrenRecursive());e.push(t,...s)}U.print("scene",this.name),U.print("objects",t.length),U.print("ui",e.length)}}getAllObjects(){const t=[];for(const e of this.grid.children)t.push(...e.getChildrenRecursive());console.log(t)}}class St extends it{obj=null;pointerDown=!1;offset=c(0,8);snapParent=null;getName(){return"CURSOR"}update(){let t=B.getObjAt(Y.pointer.getWorldPos()).sort(((t,e)=>t.pos.y-e.pos.y)).pop()??null;t!==this.obj&&this.obj?.onPointerOut(),this.obj=t,this.obj?.onPointerOver(),null!==this.obj&&(this.pos=this.obj.getWorldPos().clone(),!this.pointerDown&&Y.isPointerDown()&&(this.pointerDown=!0,this.obj.onPointerDown()),this.pointerDown&&!Y.isPointerDown()&&(this.pointerDown=!1))}draw(){}debug(){let t=this.pos.toString();this.obj&&(t+=` "${this.obj.getName()}" ${this.obj.pos.toString()}`),U.print("cursor",t)}}const Dt=(Pt=c(),new St(0,Pt));var Pt;class bt{constructor(t,e,s,i){this.gameStart=t,this.gameUpdate=e,this.gameDraw=s,this.gameDebug=i,this.frame=0,this.lastFrame=0}async start(){const t=Q.start();Y.start(),window.__scene=t,window.__pm=mt;try{await this.gameStart(t)}catch(t){console.error("error starting game",t)}this.tick()}tick(){const t=Q.getActiveScene(),e=Date.now(),s=e-this.lastFrame;G.clear(),Y.update(),J.update(s),t.update(s),Dt.update(),X.update(),j.update(s),this.gameUpdate(s),t.draw(),X.draw(),J.draw(),this.gameDraw(),t.debug(),Y.debug(),B.debug(),this.gameDebug(),j.draw(),j.debug();const i=1e3/60-(Date.now()-e);this.debug(s,i),U.draw(),this.lastFrame=e,setTimeout(this.tick.bind(this),i)}debug(t,e){U.sample("FPS AVG",t,60,(t=>(1e3/t).toFixed(2))),U.sample("FRAME HEADROOM",e,60,(t=>t.toFixed(2)+"ms")),U.print("FRAME",++this.frame)}}var Tt;Tt=new URL(o("27Lyk").resolve("1vJCw"),import.meta.url).toString();var Wt;Wt=JSON.parse('{"piece_0":{"frames":[{"x":0,"y":0,"w":96,"h":64,"ox":-128,"oy":-48},{"x":96,"y":0,"w":96,"h":64,"ox":-64,"oy":-64},{"x":192,"y":0,"w":96,"h":64,"ox":-64,"oy":-32},{"x":288,"y":0,"w":96,"h":64,"ox":-96,"oy":-32}]},"piece_1":{"frames":[{"x":0,"y":128,"w":96,"h":64,"ox":-128,"oy":-48},{"x":96,"y":128,"w":96,"h":64,"ox":-64,"oy":-64},{"x":192,"y":128,"w":96,"h":64,"ox":-64,"oy":-32},{"x":288,"y":128,"w":96,"h":64,"ox":-96,"oy":-32}]},"piece_2":{"frames":[{"x":0,"y":256,"w":96,"h":64,"ox":-96,"oy":-64},{"x":96,"y":256,"w":96,"h":64,"ox":-64,"oy":-64},{"x":192,"y":256,"w":96,"h":64,"ox":-64,"oy":-48},{"x":288,"y":256,"w":96,"h":64,"ox":-96,"oy":-48}]},"piece_3":{"frames":[{"x":0,"y":384,"w":96,"h":64,"ox":-96,"oy":-64},{"x":96,"y":384,"w":96,"h":64,"ox":-64,"oy":-80},{"x":192,"y":384,"w":96,"h":64,"ox":-32,"oy":-48},{"x":288,"y":384,"w":96,"h":64,"ox":-96,"oy":-48}]},"piece_4":{"frames":[{"x":0,"y":512,"w":96,"h":64,"ox":-96,"oy":-48},{"x":96,"y":512,"w":96,"h":64,"ox":-96,"oy":-16},{"x":192,"y":512,"w":96,"h":64,"ox":-32,"oy":-48},{"x":288,"y":512,"w":96,"h":64,"ox":-96,"oy":-48}]},"piece_5":{"frames":[{"x":0,"y":640,"w":96,"h":64,"ox":-128,"oy":-64},{"x":96,"y":640,"w":96,"h":64,"ox":-32,"oy":-64},{"x":192,"y":640,"w":96,"h":64,"ox":-64,"oy":-32},{"x":288,"y":640,"w":96,"h":64,"ox":-96,"oy":-32}]},"piece_6":{"frames":[{"x":0,"y":768,"w":96,"h":64,"ox":-96,"oy":-64},{"x":96,"y":768,"w":96,"h":64,"ox":-64,"oy":-64},{"x":0,"y":768,"w":96,"h":64,"ox":-64,"oy":-48},{"x":96,"y":768,"w":96,"h":64,"ox":-96,"oy":-48}]},"piece_7":{"frames":[{"x":0,"y":896,"w":96,"h":64,"ox":-96,"oy":-64},{"x":96,"y":896,"w":96,"h":64,"ox":-64,"oy":-48},{"x":0,"y":896,"w":96,"h":64,"ox":-96,"oy":-64},{"x":96,"y":896,"w":96,"h":64,"ox":-64,"oy":-48}]},"board":{"frames":[{"x":419,"y":43,"w":208,"h":110,"ox":0,"oy":6}]}}');const Rt=new F([[0,c(0,1)],[1,c(0,2)],[2,c(0,3)],[3,c(0,4)],[4,c(0,5)],[5,c(0,6)],[6,c(1,1)],[7,c(1,2)],[8,c(1,3)],[9,c(1,4)],[10,c(1,5)],[11,c(1,6)]]),Ct=new F([[7,c(2,0)],[6,c(2,1)],[5,c(2,2)],[4,c(2,3)],[3,c(2,4)],[2,c(2,5)],[1,c(2,6)],[14,c(3,0)],[13,c(3,1)],[12,c(3,2)],[11,c(3,3)],[10,c(3,4)],[9,c(3,5)],[8,c(3,6)],[21,c(4,0)],[20,c(4,1)],[19,c(4,2)],[18,c(4,3)],[17,c(4,4)],[16,c(4,5)],[15,c(4,6)],[28,c(5,0)],[27,c(5,1)],[26,c(5,2)],[25,c(5,3)],[24,c(5,4)],[23,c(5,5)],[22,c(5,6)],[31,c(6,4)],[30,c(6,5)],[29,c(6,6)]]);class Ft extends ct{constructor(t,e,s,i,o,r,n){super(t,e,s,c(-224,-16)),this.localWidth=i,this.localHeight=o,this.invalidNodes=r,this.solution=n,this.localRect=b(0,0,this.localWidth,this.localHeight),V.listen("update_date",(t=>{this.solution[0]=Rt.get(t.date.getMonth()),this.solution[1]=Ct.get(t.date.getDate())}))}getName(){return"BOARD"}getLocalPos(){return this.getGrid().worldToLocalUnsafe(this.pos)}updateLocalRect(t){this.localRect.pos=t.clone()}isValidPlacement(t){const e=this.invalidNodes.map((t=>t.addv(this.getLocalPos())));return!t.some((t=>e.find((e=>e.equalsv(t)))))&&(!!t.every((t=>this.localRect.contains(t)))||!!t.every((t=>!this.localRect.contains(t))))}draw(){super.draw(1,"board");const t=this.getGrid();for(const e of this.solution)G.drawISoRect(this.getWorldPos().addv(t.localToWorld(e)),t.size,t.size,v.green(),!1,c(0,-t.size/2),4,"board")}getNodes(){const t=this.getLocalPos(),e=[];for(let s=0;s<this.localRect.width;s++)for(let i=0;i<this.localRect.height;i++){const o=c(s,i);this.invalidNodes.find((t=>t.equalsv(o)))||e.push(o.addv(t))}return e}getSolutionNodes(){return this.solution.map((t=>t.addv(this.getLocalPos())))}debug(){}}function Et(t,e,s){return new Nt(t.date.getTime(),e,t,s)}class Nt extends ot{static Width=80;static Height=80;static Padding=16;constructor(t,e,s,i){super(t,e),this.day=s,this.active=i}draw(){G.fillRect(this.getWorldPos(),Nt.Width,Nt.Height,this.active?v.white():v.red(),c(),"ui"),G.fillText(`${this.day.date.getDate()}/${this.day.date.getMonth()+1}`,this.getWorldPos(),v.green(),Nt.Width,"ui")}setActive(t){this.active=t}getDay(){return this.day}getName(){return""}onClick(){V.trigger("update_date",{date:this.day.date})}}const At=at();function _t(t){return new Lt(At(),c(),t)}class Lt extends ot{constructor(t,e,s){super(t,e),this.dir=s}getDir(){return this.dir}draw(){G.fillRect(this.getWorldPos(),Nt.Width,Nt.Height,v.green(),c(),"ui"),G.fillText(this.dir.toString(),this.getWorldPos(),v.white(),Nt.Width,"ui")}getName(){return"UI_NAV_"+this.id}onClick(){V.trigger("calendar_nav",{dir:this.dir})}}function zt(t,e){const s=new Date(e.getFullYear(),e.getMonth(),e.getDate());return t.get(s.toString())}class Ot extends ot{constructor(t,e,s,i,o,r){super(t,e),this.width=s,this.height=i,this.color=o,this.activeDate=r,this.days=function(){const t=new Date,e=t.getFullYear(),s=new Date(t.getFullYear(),0,1),i=new F;let o=s;for(;o.getFullYear()===e;){i.set(o.toString(),{date:o,complete:!1});const t=new Date(o);t.setDate(t.getDate()+1),o=t}return i}(),this.updateDays(),this.add(_t(-1),c(Nt.Padding,0)),this.add(_t(1),c(G.stage.width-(Nt.Padding+Nt.Width),0)),V.listen("calendar_nav",(t=>{this.updateDateByDir(t.dir)}))}updateDateByDir(t){if(1===t){const t=new Date(this.activeDate);t.setDate(t.getDate()+1),this.activeDate=t,this.updateDays()}if(-1===t){const t=new Date(this.activeDate);t.setDate(t.getDate()-1),this.activeDate=t,this.updateDays()}}getName(){return"UI_CALENDAR"}update(t){if(Y.isPointerDownThisFrame()&&Y.pointer.state===d.Primary&&this.isInside(Y.pointer.getScreenPos())){const t=this.getControlAtPos(Y.pointer.getScreenPos());null!==t&&(t.onClick(),t instanceof Nt&&(this.activeDate=t.getDay().date,console.log(this.activeDate)),t instanceof Lt&&V.trigger("update_date",{date:this.activeDate}),this.updateDays())}}updateDays(){for(const t of this.children)t instanceof Nt&&this.remove(t);const t=this.getDaysToDraw(),e=t.length*(Nt.Width+Nt.Padding)-Nt.Padding;let s=G.stage.width/2-e/2;for(const e of t)this.add(Et(e,c(s,0),(i=e.date,o=this.activeDate,i.getDate()===o.getDate()&&i.getFullYear()===o.getFullYear()&&i.getMonth()===o.getMonth()))),s+=Nt.Width+Nt.Padding;var i,o}getControlAtPos(t){const e=[...this.children];for(const s of e){if(T.getRect({pos:s.getWorldPos(),width:Nt.Width,height:Nt.Height}).contains(t))return s}return null}isInside(t){return T.getRect(this).contains(t)}getDaysToDraw(){const t=zt(this.days,this.activeDate),e=[t];let s=t.date,i=t.date;for(let t=0;t<this.getDrawableDayLength()-1;t++)if(t%2!=0){const t=new Date(s);t.setDate(t.getDate()+1),e.push(zt(this.days,t)),s=t}else{const t=new Date(i);t.setDate(t.getDate()-1),e.unshift(zt(this.days,t)),i=t}return e}getDrawableDayLength(){const t=Math.floor(G.stage.width/(Nt.Width+Nt.Padding)-2);return t%2==0?t-1:t}draw(){G.fillRect(this.pos,this.width,this.height,this.color,c(),"ui")}onClick(){}}function kt(t){const e=[];for(let s=0;s<t.length;s+=4)e.push([t[s],t[s+1],t[s+2],t[s+3]]);return e}function Mt(t){return 0===t[3]}function It(t,e){return t[0]===e.r&&t[1]===e.g&&t[2]===e.b&&t[3]===255*e.a}function qt(t,e,s){return 0===t.y?4*t.x:t.y*(4*e)+4*t.x}function $t(t,e){return[t[e],t[e+1],t[e+2],t[e+3]]}const Gt=function(t="main",e,s){return new vt(t,function(t,e=t,s=c(),i=32,o=((t,e)=>({local:t,world:e}))){return new st(t,e,s,i,o)}(e,s))}("main",16,16),jt=new lt(0,c());Q.addScene(Gt),j.snapTo(c(0,-260)),Gt.addGameObject(jt),new bt((async t=>{await K.loadSheet("puzzle",Tt,Wt);let e=Date.now();var s,i,o,r,n,a,h;!function(){for(const t of K.getByPrefix("piece")){const e=new z(t.getName()+"_shadow",t.getWidth(),t.getHeight());for(const s of t.getFrames()){const{img:t,height:i,width:o}=s,r=P(o,i),{data:n}=t.getContext("2d").getImageData(0,0,o,i),a=new Uint8ClampedArray(o*i*4);let h=0;for(const t of kt([...n]))Mt(t)?(a.set([0],h++),a.set([0],h++),a.set([0],h++),a.set([0],h++)):(a.set([0],h++),a.set([0],h++),a.set([0],h++),a.set([Math.round(127.5)],h++));r.ctx.putImageData(new ImageData(a,o,i),0,0),e.addFrame({...s,img:r.el})}K.addSprite(e)}}(),console.log("create shadows: ",Date.now()-e,"ms"),e=Date.now(),function(){for(const t of K.getByPrefix("piece")){if(t.getName().endsWith("_shadow"))continue;const e=new z(t.getName()+"_outline",t.getWidth(),t.getHeight());for(const s of t.getFrames()){const{img:t,width:i,height:o}=s,r=P(i,o),{data:n}=t.getContext("2d").getImageData(0,0,i,o),a=new Uint8ClampedArray(i*o*4);a.set(n,0);const h=t=>!Mt(t)&&!It(t,v.white());for(let t=0;t<i;t++)for(let e=0;e<o;e++){const s=qt(c(t,e),i),r=[n[s],n[s+1],n[s+2],n[s+3]],l=$t(a,qt(c(N(t-1,0,i),e),i));(0===t&&h(r)||t===i-1&&h(r)||0===e&&h(r)||e===o-1&&h(r)||Mt(l)&&h(r)||h(l)&&Mt(r))&&(a.set([255,255,255,255],s),a.set([255,255,255,255],s-4),a.set([255,255,255,255],s-8),a.set([255,255,255,255],s-12),a.set([255,255,255,255],s+4),a.set([255,255,255,255],s+8),a.set([255,255,255,255],s+12))}for(let t=0;t<o;t++)for(let e=0;e<i;e++){const s=qt(c(e,t),i),r=[n[s],n[s+1],n[s+2],n[s+3]],l=$t(a,qt(c(e,N(t-1,0,o)),i));(0===e&&h(r)||e===i-1&&h(r)||0===t&&h(r)||t===o-1&&h(r)||Mt(l)&&h(r)||h(l)&&Mt(r))&&a.set([255,255,255,255],s)}r.ctx.putImageData(new ImageData(a,i,o),0,0),e.addFrame({...s,img:r.el})}K.addSprite(e)}}(),console.log("create outlines: ",Date.now()-e,"ms"),e=Date.now(),function(){for(const s of K.getByPrefix("piece")){if(s.getName().endsWith("_shadow"))continue;const i=new z(s.getName()+"_highlight",s.getWidth(),s.getHeight());for(const o of s.getFrames()){const{img:s,width:r,height:n}=o,a=P(r,n),{data:h}=s.getContext("2d").getImageData(0,0,r,n),l=new Uint8ClampedArray(r*n*4);l.set(h,0);for(let s=0;s<r;s++)for(let i=0;i<n;i++){const o=qt(c(s,i),r);e=[24,20,37,255],(t=$t(l,o))[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&l.set([255,255,255,255],o)}a.ctx.putImageData(new ImageData(l,r,n),0,0),i.addFrame({...o,img:a.el})}K.addSprite(i)}var t,e}(),console.log("create highlights: ",Date.now()-e,"ms"),mt.start(t.grid),t.addUIObject((s=G.stage.width,i=96,o=new Date,new Ot(0,c(),s,i,v.black(),o)),c(0,G.stage.height-96)),yt.loadState((t=>{const e=[ft.get("piece_0")(t.localToWorld(c(2,11)),l.North),ft.get("piece_1")(t.localToWorld(c(7,1)),l.East),ft.get("piece_2")(t.localToWorld(c(6,12)),l.West),ft.get("piece_3")(t.localToWorld(c(11,13)),l.East),ft.get("piece_4")(t.localToWorld(c(1,1)),l.East),ft.get("piece_5")(t.localToWorld(c(0,6)),l.South),ft.get("piece_6")(t.localToWorld(c(12,7)),l.North),ft.get("piece_7")(t.localToWorld(c(12,2)),l.East)];return e.forEach((e=>e.parent=t)),{pieces:e.map((t=>t.serialise()))}})(t.grid)),mt.addBoardToGrid((r=7,n=7,a=[c(),c(1,0),c(6,0),c(6,1),c(6,2),c(6,3)],h=[c(1,2),c(4,4)],new Ft(0,c(),K.get("board"),r,n,a,h)),c(4,4))}),(t=>{yt.update()}),(()=>{}),(()=>{mt.debug()})).start();
//# sourceMappingURL=index.22798114.js.map
